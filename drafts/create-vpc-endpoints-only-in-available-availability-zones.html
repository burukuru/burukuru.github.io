
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://thanhpham.cloud/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://thanhpham.cloud/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://thanhpham.cloud/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://thanhpham.cloud/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://thanhpham.cloud/theme/font-awesome/css/solid.css">





<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-165492269-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Thanh" />
<meta name="description" content="Background A common practice when using AWS is to deploy to multiple availability zones (AZs) for resiliency, usually this would be 3 AZs. Some bigger AWS regions have more than 3 AZs: us-east-1 (6), us-west-2 (4), ap-northeast-1 (4). When making a decision to deploy your services to only some of …" />
<meta name="keywords" content="devops, terraform, aws">

<meta property="og:site_name" content="Cloud Magic"/>
<meta property="og:title" content="Create VPC Endpoints only in available availability zones"/>
<meta property="og:description" content="Background A common practice when using AWS is to deploy to multiple availability zones (AZs) for resiliency, usually this would be 3 AZs. Some bigger AWS regions have more than 3 AZs: us-east-1 (6), us-west-2 (4), ap-northeast-1 (4). When making a decision to deploy your services to only some of …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://thanhpham.cloud/drafts/create-vpc-endpoints-only-in-available-availability-zones.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-06-06 14:20:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://thanhpham.cloud/author/thanh.html">
<meta property="article:section" content="DevOps"/>
<meta property="article:tag" content="devops"/>
<meta property="article:tag" content="terraform"/>
<meta property="article:tag" content="aws"/>
<meta property="og:image" content="/upload/profile.jpg">

  <title>Cloud Magic &ndash; Create VPC Endpoints only in available availability zones</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://thanhpham.cloud">
        <img src="/upload/profile.jpg" alt="Cloud Magic" title="Cloud Magic">
      </a>
      <h1><a href="https://thanhpham.cloud">Cloud Magic</a></h1>


      <nav>
        <ul class="list">
          <li><a href="https://thanhpham.cloud/pages/about.html#about">About</a></li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/burukuru" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/thanh-pham-cloud/" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-medium" href="https://medium.com/@burukuru" target="_blank">
            <i class="fab fa-medium">
            </i>
          </a></li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/burukuru" target="_blank">
            <i class="fab fa-twitter">
            </i>
          </a></li>
          <li>
            <a  class="sc-flickr" href="https://flickr.com/burukuru" target="_blank">
            <i class="fab fa-flickr">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://thanhpham.cloud">    Home
</a>

      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="create-vpc-endpoints-only-in-available-availability-zones">Create VPC Endpoints only in available availability zones</h1>
    <p>
          Posted on Sat 06 June 2020 in <a href="https://thanhpham.cloud/category/devops.html">DevOps</a>


    </p>
  </header>


  <div>
    <h1>Background</h1>
<p>A common practice when using AWS is to deploy to multiple availability zones (AZs) for resiliency, usually this would be 3 AZs. Some bigger <a href="https://aws.amazon.com/about-aws/global-infrastructure/regions_az/">AWS regions have more than 3 AZs</a>: us-east-1 (6), us-west-2 (4), ap-northeast-1 (4).<br>
When making a decision to deploy your services to only some of those regions, for cost savings or otherwise, you will need to match the resources in the VPC that consumes those services to subnets/availability zones where the services are available. This should be easy except that AWS availability zone names do not represent the same AZ in each account, you need <a href="https://docs.aws.amazon.com/ram/latest/userguide/working-with-az-ids.html">AZ IDs</a> for that. You could hard code AZ IDs everywhere but that sounds like more headache down the line.</p>
<h1>Terraform</h1>
<p>In Python this would be a list comprehension, in any other language a for loop, in Terraform we will need to use the <a href="https://www.terraform.io/docs/configuration/functions/matchkeys.html">matchkeys() function</a>.</p>
<p>In this specific example, we are deploying a service in one AWS account and exposing it to another AWS account via a VPC endpoint service.<br>
The consumer account needs to deploy a VPC endpoint in the subnet matching the AZ of the service.</p>
<h2>AZ to subnet mapping</h2>
<p>First, in our VPC module, we need to create a new output which is a map of AZs to subnets. This will later allow us to look up the AZ of the service and obtain the corresponding subnet that we need to use for our 'consumer' resource.</p>
<div class="highlight"><pre><span></span><code><span class="kr">output</span> <span class="s">&quot;az_subnet_map&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">  value</span> <span class="o">=</span> <span class="err">zipmap</span><span class="p">(</span><span class="err">aws_subnet</span><span class="p">.</span><span class="err">private</span><span class="p">[</span><span class="err">*</span><span class="p">.</span><span class="err">availability_zone</span><span class="p">,</span> <span class="err">aws_subnet</span><span class="p">.</span><span class="err">private</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="err">id</span><span class="p">)</span>
<span class=" -Punctuation">}</span>
</code></pre></div>


<p>In the Terraform project for your consumer account, you will specify the VPC endpoints services to connect to.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># terraform.tfvars</span>
<span class="l l-Scalar l-Scalar-Plain">vpc_endpoint_services ={</span> 
        <span class="l l-Scalar l-Scalar-Plain">service1 = {</span>
                <span class="l l-Scalar l-Scalar-Plain">service_name = &quot;com.amazonaws.us-east-1.service1&quot;</span>
                <span class="l l-Scalar l-Scalar-Plain">description  = &quot;Service1 from Account A&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">}</span>
<span class="l l-Scalar l-Scalar-Plain">}</span>
</code></pre></div>


<h2>Get availability zones for the endpoint services</h2>
<p>You will need to obtain the endpoint services' AZs by doing a data lookup.</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">data &quot;aws_vpc_endpoint_service&quot; &quot;selected&quot; {</span>
        <span class="l l-Scalar l-Scalar-Plain">for_each = var.vpc_endpoint_services</span>

        <span class="l l-Scalar l-Scalar-Plain">service_name = each.value[service_name]</span>
<span class="l l-Scalar l-Scalar-Plain">}</span>
</code></pre></div>


<h2>Match the endpoint services to our subnets</h2>
<p>Create VPC Endpoints in matching availability zones using matchkeys():</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">resource &quot;aws_vpc_endpoint&quot; &quot;vpc_endpoints&quot; {</span>

        <span class="l l-Scalar l-Scalar-Plain">for_each = var.vpc_endpoint_services</span>

        <span class="l l-Scalar l-Scalar-Plain">service_name        = each.value[service_name]</span>
        <span class="l l-Scalar l-Scalar-Plain">subnet_ids          = flatten([matchkeys(</span>
                        <span class="l l-Scalar l-Scalar-Plain">values(module.vpc.az_subnet_map),</span>
                        <span class="l l-Scalar l-Scalar-Plain">keys(module.vpc.az_subnet_map),</span>
                        <span class="l l-Scalar l-Scalar-Plain">data.aws_vpc_endpoint_service.selected[each.key].availability_zones</span>
                        <span class="l l-Scalar l-Scalar-Plain">)])</span>

        <span class="l l-Scalar l-Scalar-Plain">vpc_id              = module.vpc.vpc_id</span>
        <span class="l l-Scalar l-Scalar-Plain">security_group_ids  = [aws_security_group.endpoint.id]</span>
        <span class="l l-Scalar l-Scalar-Plain">vpc_endpoint_type   = &quot;Interface&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">private_dns_enabled = false</span>
        <span class="l l-Scalar l-Scalar-Plain">auto_accept         = true</span>

<span class="l l-Scalar l-Scalar-Plain">}</span>
</code></pre></div>


<p><code>matchkeys</code> will look up the AZs of the endpoint services in the AZ-&gt;subnet map we have in our VPC and return the corresponding subnets.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://thanhpham.cloud/tag/devops.html">devops</a>
      <a href="https://thanhpham.cloud/tag/terraform.html">terraform</a>
      <a href="https://thanhpham.cloud/tag/aws.html">aws</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Cloud Magic ",
  "url" : "https://thanhpham.cloud",
  "image": "/upload/profile.jpg",
  "description": ""
}
</script>

</body>
</html>